<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promosyon Quizleri</title>
    <style>
        /* index.html dosyasındaki ilgili CSS stillerini buraya kopyalayacağız */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a1f44;
            color: #ffffff;
            padding: 20px;
        }

        .quiz-container {
            background: #142d5f;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .quiz-question {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffc107; /* Sarı */
        }

        .quiz-options {
            display: grid;
            gap: 10px;
        }

        .quiz-option {
            background: #0a1f44;
            border: 2px solid #1a3a6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-option:hover {
            border-color: #ffc107;
            background: #1a3a6b;
        }

        .quiz-option.selected {
            border-color: #ffc107;
            background: #ffc107;
            color: #0a1f44;
        }

        .quiz-option.correct {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .quiz-option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .quiz-button {
            background: #ffc107;
            color: #0a1f44;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .quiz-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: #ffeb3b;
        }

        .quiz-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .score-display {
            background: #1a3a6b;
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #0a1f44; /* Koyu lacivert */
            color: #ffffff; /* Beyaz metin */
        }

    </style>
</head>
<body>
    <div class="quiz-container">
        <h3 style="margin-bottom: 20px; color: #ffc107;">🎯 Quizler</h3>
        
        <div class="quiz-category-tabs" style="display: flex; margin-bottom: 20px; border-radius: 10px; overflow: hidden;">
            <button class="quiz-category-tab active" id="tab-promosyon" onclick="showQuizCategory('promosyon')" style="flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #ffc107; color: #0a1f44; font-weight: bold; transition: all 0.3s ease;">
                Promosyon Quizleri
            </button>
            <button class="quiz-category-tab" id="tab-saglayici" onclick="showQuizCategory('saglayici')" style="flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #1a3a6b; color: #ffffff; font-weight: bold; transition: all 0.3s ease;">
                Sağlayıcı Quizleri
            </button>
        </div>

        <div class="form-group" style="margin-bottom: 20px;">
            <label>Quiz Yapmak İstediğiniz Promosyonu Seçin:</label>
            <select id="promo-select" onchange="loadQuiz()" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 8px;">
                <option value="">Promosyon seçin...</option>
            </select>
        </div>

        <div id="quiz-content" style="display: none;">
            <div class="quiz-question" id="quiz-question">
                Soru yükleniyor...
            </div>
            <div class="quiz-options" id="quiz-options">
                <!-- Seçenekler buraya yüklenecek -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="quiz-button" onclick="checkAnswer()" id="check-btn">Cevabı Kontrol Et</button>
                <button class="quiz-button" onclick="loadQuiz()" style="background: #ffeb3b; color: #0a1f44;">🔄 Yeni Soru</button>
            </div>
        </div>

        <div class="score-display" id="score-display" style="display: none;">
            <div id="score-text"></div>
        </div>
    </div>

    <script>
        let currentAnswer = -1;
        let currentQuiz = null;
        let regularPromos = []; // Normal promosyonlar
        let providerPromos = []; // Sağlayıcı promosyonları
        let activePromos = []; // Şu an aktif olan promosyon listesi
        let currentQuizCategory = 'promosyon'; // Varsayılan olarak promosyon quizleri aktif

        // Yardımcı fonksiyon: Metin temizleme
        function cleanText(text) {
            if (typeof text !== 'string') return text;
            // Numaralandırma, özel karakterler ve fazla boşlukları temizle
            // Cümle sonundaki noktalama işaretlerini kaldır, ancak sayıların içindeki noktalara dokunma (örn. 1.50)
            return text.replace(/^\d+\.\s*/, '') // Başındaki '1. ' gibi numaralandırmayı kaldır
                       .replace(/\s*([.,;])\s*$/, '') // Cümle sonundaki noktalama işaretlerini kaldır
                       .replace(/\s+/g, ' ') // Birden fazla boşluğu tek boşluğa çevir
                       .trim();
        }

        // Yardımcı fonksiyon: Sayısal bir değerden rastgele yanlış seçenekler üretir
        function generateNumericWrongOptions(correctAnswer, count = 3) {
            const wrongOptions = new Set();
            let numAnswerString = correctAnswer.replace(/[^0-9.,]/g, ''); // Sadece sayısal karakterler, nokta ve virgül kalır
            
            // Eğer binlik ayraç olarak nokta, ondalık ayraç olarak virgül kullanılıyorsa
            // Örnek: "10.000.000,50 EUR" -> "10000000,50" -> "10000000.50"
            // Örnek: "10.000.000 EUR" -> "10000000"
            if (numAnswerString.includes('.') && numAnswerString.includes(',') && numAnswerString.indexOf('.') < numAnswerString.indexOf(',')) {
                numAnswerString = numAnswerString.replace(/\./g, '').replace(',', '.');
            } else if (numAnswerString.includes('.') && !numAnswerString.includes(',') && numAnswerString.lastIndexOf('.') !== numAnswerString.indexOf('.')) {
                // Birden fazla nokta varsa ve virgül yoksa, noktaları binlik ayraç olarak kabul et
                numAnswerString = numAnswerString.replace(/\./g, '');
            } else if (numAnswerString.includes(',') && !numAnswerString.includes('.')) {
                // Sadece virgül varsa, virgülü ondalık ayraç olarak kabul et
                numAnswerString = numAnswerString.replace(',', '.');
            }

            const numAnswer = parseFloat(numAnswerString); // Sayısal değeri çıkar
            if (isNaN(numAnswer)) return [];

            while (wrongOptions.size < count) {
                let newOption;
                const variation = numAnswer * (0.1 + Math.random() * 0.4); // %10 ila %50 varyasyon
                const operation = Math.random() > 0.5 ? 1 : -1; // Artırma veya azaltma
                newOption = Math.round((numAnswer + operation * variation) * 100) / 100; // İki ondalık basamağa yuvarla
                
                // Orijinal birimini koru
                if (correctAnswer.includes("₺")) newOption += "₺";
                else if (correctAnswer.includes("%")) newOption += "%";
                else if (correctAnswer.includes("EUR")) newOption += " EUR";
                else if (correctAnswer.includes("adet")) newOption += " adet";

                if (newOption.toString() !== correctAnswer && !wrongOptions.has(newOption.toString())) {
                    wrongOptions.add(newOption.toString());
                }
            }
            return Array.from(wrongOptions);
        }

        // Yardımcı fonksiyon: Tarih veya süre bilgisinden yanlış seçenekler üretir
        function generateTimeWrongOptions(correctAnswer, count = 3) {
            const wrongOptions = new Set();
            const phrases = ["24 saat", "48 saat", "72 saat", "1 gün", "3 gün", "5 gün", "1 hafta", "1 ay", "6 ay", "1 yıl", "Belirtilmemiş", "Süresiz"];

            while (wrongOptions.size < count) {
                const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
                if (randomPhrase !== correctAnswer && !wrongOptions.has(randomPhrase)) {
                    wrongOptions.add(randomPhrase);
                }
            }
            return Array.from(wrongOptions);
        }

        // Yardımcı fonksiyon: Genel metinlerden yanlış seçenekler üretir
        function generateGeneralWrongOptions(correctAnswer, allPossibleAnswers, count = 3) {
            const wrongOptions = new Set();
            const genericOptions = ["Belirtilmemiş", "Değişkendir", "Bilgi yok", "Geçersiz", "Her zaman geçerli", "Tüm oyunlarda", "Hiçbiri", "Farklı bir koşula bağlı", "Ekstra bir şart yok", "Canlı destekten öğrenilmeli", "Özel bir kod ile", "Sadece yeni üyelere özel", "Sadece spor", "Sadece casino", "Canlı destek", "E-posta", "Çevrim şartsız", "Sadece belli günler", "Geçersiz bonus kodu"];

            const cleanedCorrectAnswer = cleanText(correctAnswer);

            // Populate contextual options, excluding numbers and time
            const contextualOptions = new Set();
            activePromos.forEach(p => {
                if (p.basicInfo) {
                    Object.values(p.basicInfo).forEach(val => {
                        const cleanedVal = cleanText(val);
                        if (cleanedVal !== cleanedCorrectAnswer && !val.match(/^\\d+[.,]?\\d*\\s*[₺$€%]/i) && !val.match(/\\d+\\s*(saat|gün|hafta|ay|yıl)/i)) {
                            contextualOptions.add(cleanedVal);
                        }
                    });
                }
                if (p.sections) {
                    const sectionContents = Array.isArray(p.sections) ? p.sections.flatMap(s => s.content || []).filter(item => typeof item === 'string') : 
                                            Object.values(p.sections).flatMap(s => s.content || []).filter(item => typeof item === 'string');
                    sectionContents.forEach(val => {
                        const cleanedVal = cleanText(val);
                        if (cleanedVal !== cleanedCorrectAnswer && !val.match(/^\\d+[.,]?\\d*\\s*[₺$€%]/i) && !val.match(/\\d+\\s*(saat|gün|hafta|ay|yıl)/i)) {
                            contextualOptions.add(cleanedVal);
                        }
                    });
                }
            });

            // Create a pool of potential wrong answers
            let pool = Array.from(contextualOptions);
            Array.from(allPossibleAnswers).forEach(opt => {
                const cleanedOpt = cleanText(opt);
                if (cleanedOpt !== cleanedCorrectAnswer && !pool.includes(cleanedOpt)) {
                    pool.push(cleanedOpt);
                }
            });
            
            // Add generic options to the pool if not already present
            genericOptions.forEach(opt => {
                const cleanedOpt = cleanText(opt);
                if (cleanedOpt !== cleanedCorrectAnswer && !pool.includes(cleanedOpt)) {
                    pool.push(cleanedOpt);
                }
            });

            // Shuffle the pool to pick random options
            pool.sort(() => Math.random() - 0.5);

            // Select 'count' unique wrong options
            while (wrongOptions.size < count && pool.length > 0) {
                const option = pool.shift(); // Take from the front of the shuffled pool
                wrongOptions.add(option);
            }
            
            // If still not enough, aggressively add from generic options (already in pool, but ensure minimum count)
            let genericIndex = 0;
            while (wrongOptions.size < count && genericIndex < genericOptions.length) {
                const genOption = cleanText(genericOptions[genericIndex]);
                if (genOption !== cleanedCorrectAnswer && !wrongOptions.has(genOption)) {
                    wrongOptions.add(genOption);
                }
                genericIndex++;
            }

            return Array.from(wrongOptions);
        }

        // Dinamik quiz soruları oluşturma fonksiyonu
        function generateQuizQuestions(promo) {
            const dynamicQuizzes = [];
            const allContentItems = []; // Hata veren değişkeni burada tanımlıyoruz

            // generateQuizQuestions içindeki promos.forEach döngüsünü activePromos olarak değiştir
            activePromos.forEach(p => {
                if (p.basicInfo) allContentItems.push(...Object.values(p.basicInfo).map(cleanText));
                if (p.sections) {
                    const sectionContents = Array.isArray(p.sections) ? p.sections.flatMap(s => s.content || []).filter(item => typeof item === 'string') : 
                                            Object.values(p.sections).flatMap(s => s.content || []).filter(item => typeof item === 'string');
                    allContentItems.push(...sectionContents.map(cleanText));
                }
            });
            const uniqueAllPossibleAnswers = Array.from(new Set(allContentItems)).filter(Boolean);


            // 1. basicInfo'dan sorular oluşturma
            if (promo.basicInfo) {
                for (const key in promo.basicInfo) {
                    if (Object.hasOwnProperty.call(promo.basicInfo, key)) {
                        const answer = cleanText(promo.basicInfo[key]);
                        if (answer && answer !== "Yok" && answer !== "Süresiz" && answer !== "Her zaman") {
                            const question = `${promo.title} promosyonunda "${key}" nedir?`;
                            let options = [answer]; // Doğru cevap

                            // Sayısal değerler için özel yanlış seçenekler
                            if (key.includes("Miktar") || key.includes("Yatırım") || key.includes("Kazanç") || key.includes("Bahis") || key.includes("Freespin") || key.includes("Oran")) {
                                options = options.concat(generateNumericWrongOptions(answer, 3));
                            } else if (key.includes("Tarih") || key.includes("Süresi") || key.includes("Günler")) {
                                options = options.concat(generateTimeWrongOptions(answer, 3));
                            } else if (key.includes("Geçerli Oyunlar") || key.includes("Geçerli Müsabakalar") || key.includes("Yöntem")) {
                                // Bu tür anahtar kelimeler için daha iyi yanlış şıklar üretilebilir
                                options = options.concat(generateGeneralWrongOptions(answer, uniqueAllPossibleAnswers, 3));
                            } else {
                                options = options.concat(generateGeneralWrongOptions(answer, uniqueAllPossibleAnswers, 3));
                            }

                            options = options.sort(() => Math.random() - 0.5);
                            const correctIndex = options.indexOf(answer);

                            // Soru tekrarını önlemek için kontrol
                            if (correctIndex !== -1 && options.length > 1 && !dynamicQuizzes.some(q => cleanText(q.question) === cleanText(question))) {
                                dynamicQuizzes.push({
                                    question: question,
                                    options: options,
                                    correct: correctIndex,
                                    explanation: `${promo.title} promosyonunda "${key}", ${answer} olarak belirtilmiştir.`
                                });
                            }
                        }
                    }
                }
            }

            // 2. sections'tan sorular oluşturma (daha derinlemesine)
            if (promo.sections) {
                const allSectionTitles = [];

                if (typeof promo.sections === 'object' && !Array.isArray(promo.sections)) {
                    for (const sectionKey in promo.sections) {
                        if (Object.hasOwnProperty.call(promo.sections, sectionKey)) {
                            const section = promo.sections[sectionKey];
                            allSectionTitles.push(cleanText(section.title));
                            if (section.content && Array.isArray(section.content)) {
                                allContentItems.push(...section.content.map(cleanText));
                            }
                            if (section.items && Array.isArray(section.items)) {
                                allContentItems.push(...section.items.map(cleanText));
                            }
                        }
                    }
                } else if (Array.isArray(promo.sections)) {
                    promo.sections.forEach(section => {
                        allSectionTitles.push(cleanText(section.title));
                        if (section.content && typeof section.content === 'string') {
                            allContentItems.push(cleanText(section.content));
                        }
                        if (section.items && Array.isArray(section.items)) {
                            allContentItems.push(...section.items.map(cleanText));
                        }
                    });
                }

                allContentItems.forEach(item => {
                    // Ortak soru kalıpları için regex match'ler

                    // Minimum yatırım miktarı soruları
                    let match = item.match(/(?:minimum|en az)\s*(\d+[.,]?\d*\s*[₺$€]|\d+\s*Freespin|\d+\s*TL|\d+\s*EUR|\d+\s*adet)\s*(?:tutarında|yatırım|bahis)/i);
                    if (match) {
                        const amount = cleanText(match[1]);
                        const question = `Bu promosyondan yararlanmak için minimum yatırım/bahis miktarı ne kadardır?`;
                        let options = [amount];
                        options = options.concat(generateNumericWrongOptions(amount, 3));
                        options = options.sort(() => Math.random() - 0.5);
                        const correctIndex = options.indexOf(amount);
                        if (correctIndex !== -1 && options.length > 1 && !dynamicQuizzes.some(q => cleanText(q.question) === cleanText(question))) {
                            dynamicQuizzes.push({
                                question: question,
                                options: options,
                                correct: correctIndex,
                                explanation: `Minimum yatırım/bahis miktarı ${amount} olarak belirtilmiştir.`
                            });
                        }
                    }

                    // Maksimum freespin/bonus miktarı soruları
                    match = item.match(/maksimum\s*(\d+[.,]?\d*\s*[₺$€]|\d+\s*Freespin|\d+\s*adet)\s*(?:kazanç|freebet|bonus miktarı|freespin)/i);
                    if (match) {
                        const amount = cleanText(match[1]);
                        const question = `Bu promosyonda alınabilecek maksimum ${match[2].toLowerCase().includes('freespin') ? 'freespin' : 'bonus/kazanç'} miktarı ne kadardır?`;
                        let options = [amount];
                        options = options.concat(generateNumericWrongOptions(amount, 3));
                        options = options.sort(() => Math.random() - 0.5);
                        const correctIndex = options.indexOf(amount);
                        if (correctIndex !== -1 && options.length > 1 && !dynamicQuizzes.some(q => cleanText(q.question) === cleanText(question))) {
                            dynamicQuizzes.push({
                                question: question,
                                options: options,
                                correct: correctIndex,
                                explanation: `Maksimum ${match[2].toLowerCase().includes('freespin') ? 'freespin' : 'bonus/kazanç'} miktarı ${amount} olarak belirtilmiştir.`
                            });
                        }
                    }

                    // Geçerlilik süresi soruları (daha genel)
                    match = item.match(/(?:geçerlilik süresi|\d+\s*(saat|gün|hafta|ay|yıl)\s*içinde kullanılmalıdır|\d+\s*(saat|gün|hafta|ay|yıl)\s*geçerlidir)/i);
                    if (match) {
                        const duration = cleanText(match[0].toLowerCase().includes('geçerlilik süresi') ? item.split(/geçerlilik süresi\s*[:-]?\s*/i)[1].split(/\.|,|olmaktadır/i)[0].trim() : match[0]);
                        if (duration && duration !== "Süresiz") {
                            const question = `Bu promosyonun geçerlilik süresi ne kadardır?`;
                            let options = [duration];
                            options = options.concat(generateTimeWrongOptions(duration, 3));
                            options = options.sort(() => Math.random() - 0.5);
                            const correctIndex = options.indexOf(duration);
                            if (correctIndex !== -1 && options.length > 1 && !dynamicQuizzes.some(q => cleanText(q.question) === cleanText(question))) {
                                dynamicQuizzes.push({
                                    question: question,
                                    options: options,
                                    correct: correctIndex,
                                    explanation: `Promosyonun geçerlilik süresi ${duration} olarak belirtilmiştir.`
                                });
                            }
                        }
                    }
                    
                    // Çevrim şartı soruları (daha detaylı regex)
                    match = item.match(/(?:çevrim şartı|çevrimini tamamlamanız için|çevrim oranı)\s*[:-]?\s*([\d\w%\s.,₺]+)(?:\.|\n|$)/i);
                    if (match) {
                        const wager = cleanText(match[1]);
                        if (wager && wager !== "Yok" && wager !== "Bulunmamaktadır") {
                            const question = `Bu promosyonun çevrim şartı nedir?`;
                            let options = [wager];
                            options = options.concat(generateGeneralWrongOptions(wager, uniqueAllPossibleAnswers, 3));
                            options = options.sort(() => Math.random() - 0.5);
                            const correctIndex = options.indexOf(wager);
                            if (correctIndex !== -1 && options.length > 1 && !dynamicQuizzes.some(q => cleanText(q.question) === cleanText(question))) {
                                dynamicQuizzes.push({
                                    question: question,
                                    options: options,
                                    correct: correctIndex,
                                    explanation: `Çevrim şartı ${wager} olarak belirtilmiştir.`
                                });
                            }
                        }
                    }

                    // Geçerli oyunlar/alanlar/branşlar soruları (daha esnek regex)
                    match = item.match(/(?:geçerli oyunlar|geçerlidir|kullanılabilir|alanında geçerli)\s*[:-]?\s*(.+?)(?:\.|\n|$|hariç|dışında)/i);
                    if (match && !item.toLowerCase().includes("geçerli değil") && !item.toLowerCase().includes("hariç")) { 
                        const games = match[1].split(/,|ve|hariç|dışında|veya/i).map(g => cleanText(g)).filter(g => g.length > 0 && !g.toLowerCase().includes("belirtilmedikçe"));
                        if (games.length > 0) {
                            const correctAnswer = games[0]; 
                            const question = `Bu promosyonda geçerli olan oyun/alan/branşlardan biri hangisidir?`;
                            let options = [correctAnswer];
                            options = options.concat(generateGeneralWrongOptions(correctAnswer, uniqueAllPossibleAnswers, 3));
                            options = options.sort(() => Math.random() - 0.5);
                            const correctIndex = options.indexOf(correctAnswer);
                            if (correctIndex !== -1 && options.length > 1 && !dynamicQuizzes.some(q => cleanText(q.question) === cleanText(question))) {
                                dynamicQuizzes.push({
                                    question: question,
                                    options: options,
                                    correct: correctIndex,
                                    explanation: `Geçerli oyun/alan/branşlardan biri ${correctAnswer} olarak belirtilmiştir.`
                                });
                            }
                        }
                    }

                    // Kimler yararlanamaz/dahil değildir soruları (Negatif soru tipi)
                    match = item.match(/(?:yararlanamaz|faydalanamaz|dahil değildir|hariç)\s*[:-]?\s*(.+?)(?:\.|\n|$)/i);
                    if (match) {
                        const cannotBenefit = match[1].split(/,|ve/i).map(g => cleanText(g)).filter(g => g.length > 0);
                        if (cannotBenefit.length > 0) {
                            const correctAnswer = cannotBenefit[0];
                            const question = `Aşağıdakilerden hangisi bu promosyondan yararlanamaz / çevrime dahil değildir?`;
                            let options = [correctAnswer];
                            options = options.concat(generateGeneralWrongOptions(correctAnswer, uniqueAllPossibleAnswers, 3));
                            options = options.sort(() => Math.random() - 0.5);
                            const correctIndex = options.indexOf(correctAnswer);
                            if (correctIndex !== -1 && options.length > 1 && !dynamicQuizzes.some(q => cleanText(q.question) === cleanText(question))) {
                                dynamicQuizzes.push({
                                    question: question,
                                    options: options,
                                    correct: correctIndex,
                                    explanation: `${correctAnswer} bu promosyondan yararlanamaz / çevrime dahil değildir olarak belirtilmiştir.`
                                });
                            }
                        }
                    }

                    // Talep edilmesi gereken durumlar/ödeme yöntemleri
                    match = item.match(/(?:talep edilmesi gerekmektedir|talep etmeniz gerekmektedir|talep edilmeli|yatırım yöntemi ile yatırım yapmanız gerekmektedir)\s*[:-]?\s*(.+?)(?:\.|\n|$)/i);
                    if (match) {
                        const claimCondition = cleanText(match[1]);
                        if (claimCondition) {
                            const question = `Bu promosyonu talep etmek için ne gereklidir veya hangi yatırım yöntemi kullanılmalıdır?`;
                            let options = [claimCondition];
                            options = options.concat(generateGeneralWrongOptions(claimCondition, uniqueAllPossibleAnswers, 3));
                            options = options.sort(() => Math.random() - 0.5);
                            const correctIndex = options.indexOf(claimCondition);
                            if (correctIndex !== -1 && options.length > 1 && !dynamicQuizzes.some(q => cleanText(q.question) === cleanText(question))) {
                                dynamicQuizzes.push({
                                    question: question,
                                    options: options,
                                    correct: correctIndex,
                                    explanation: `Promosyonun talep edilmesi için: ${claimCondition}`
                                });
                            }
                        }
                    }

                    // Bonus durdurma/iptal etme hakkı (daha spesifik)
                    match = item.match(/(?:Hproject|Hitbet)\s*dilediği zaman bu bonusu durdurma ya da iptal etme hakkına sahiptir/i);
                    if (match && !dynamicQuizzes.some(q => cleanText(q.question).includes(cleanText("Hproject, promosyonu dilediği zaman durdurma veya iptal etme hakkına sahip midir?")))) {
                        dynamicQuizzes.push({
                            question: "Hproject, promosyonu dilediği zaman durdurma veya iptal etme hakkına sahip midir?",
                            options: ["Evet", "Hayır", "Sadece üyelerin onayıyla", "Sadece belirli koşullarda"],
                            correct: 0,
                            explanation: "Evet, Hproject promosyonu dilediği zaman durdurma veya iptal etme hakkına sahiptir."
                        });
                    }

                     // Cash Out özel soruları (mevcut soruları koru ve geliştir)
                     if (promo.id === 'cash-out') {
                        // Cash Out hangi bahis türlerinde geçerlidir?
                        if (item.includes("Cash Out sadece spor bahislerinde geçerlidir")) {
                            if (!dynamicQuizzes.some(q => cleanText(q.question) === cleanText("Cash Out hangi bahis türlerinde geçerlidir?"))) {
                                dynamicQuizzes.push({
                                    question: "Cash Out hangi bahis türlerinde geçerlidir?",
                                    options: [
                                        "Casino oyunlarında",
                                        "Sadece canlı bahislerde",
                                        "Spor bahislerinde",
                                        "Slot oyunlarında"
                                    ],
                                    correct: 2,
                                    explanation: "Cash Out sadece spor bahislerinde geçerlidir."
                                });
                            }
                        }
                        // 1. Cash Out(Bahis Bozdur) özelliğinden yararlanabilmeniz için bir spor bahsinizin olması gerekmektedir.
                        if (item.includes("spor bahsinizin olması gerekmektedir")) {
                            if (!dynamicQuizzes.some(q => cleanText(q.question).includes(cleanText("Cash Out kullanmak için hangi bahis türünde kuponunuz olmalıdır?")))) {
                                dynamicQuizzes.push({
                                    question: "Cash Out kullanmak için hangi bahis türünde kuponunuz olmalıdır?",
                                    options: ["Spor bahsi", "Casino oyunu", "Canlı casino", "Sanal bahis"],
                                    correct: 0,
                                    explanation: "Cash Out özelliğinden yararlanabilmek için bir spor bahsinizin olması gerekmektedir."
                                });
                            }
                        }
                        // 2. Cash Out özelliğinden yararlanabilmeniz için bahis aldığınız market tercihinin canlı bahislerde aktif olması gerekmektedir.
                        if (item.includes("canlı bahislerde aktif olması gerekmektedir")) {
                             if (!dynamicQuizzes.some(q => cleanText(q.question).includes(cleanText("Cash Out'tan yararlanmak için bahis aldığınız market tercihinin hangi durumda olması gerekir?")))) {
                                dynamicQuizzes.push({
                                    question: "Cash Out'tan yararlanmak için bahis aldığınız market tercihinin hangi durumda olması gerekir?",
                                    options: ["Canlı bahislerde aktif olması", "Maç öncesi bahislerde aktif olması", "Tüm bahislerde aktif olması", "Herhangi bir aktiflik gerekmez"],
                                    correct: 0,
                                    explanation: "Cash Out özelliğinden yararlanabilmeniz için bahis aldığınız market tercihinin canlı bahislerde aktif olması gerekmektedir."
                                });
                            }
                        }
                        // 3. Örnek olarak MS1 oynadığınız müsabaka canlıda 3-0 önde ve ev sahibi kazanır oranı aktif değil ise(3-0 olması sebebiyle ev sahibi kazanır oranı olmayabilir) cash out seçeneği aktif olmayacaktır.
                        if (item.includes("cash out seçeneği aktif olmayacaktır.") && item.includes("oranı aktif değil ise")) {
                            if (!dynamicQuizzes.some(q => cleanText(q.question).includes(cleanText("Hangi durumda Cash Out aktif olmayabilir?")))) {
                                dynamicQuizzes.push({
                                    question: "Hangi durumda Cash Out aktif olmayabilir?",
                                    options: ["Bahis oynadığınız marketin oranı aktif değilse", "Maç sonucu berabere ise", "Maç henüz başlamamışsa", "Yatırım miktarınız az ise"],
                                    correct: 0,
                                    explanation: "Bahis oynadığınız market tercihinin canlı bahislerde aktif olmaması durumunda cash out seçeneği aktif olmayacaktır."
                                });
                            }
                        }
                        // 4. Cash Out seçeneği hemen hemen her karşılaşmada mevcuttur. Kuponlarım sayfasında Cash Out(Bahis Bozdur) ibaresini gördüğünüz her kuponda bu seçeneği değerlendirebilirsiniz.
                        if (item.includes("hemen hemen her karşılaşmada mevcuttur")) {
                            if (!dynamicQuizzes.some(q => cleanText(q.question).includes(cleanText("Cash Out seçeneği hakkında doğru ifade hangisidir?")))) {
                                dynamicQuizzes.push({
                                    question: "Cash Out seçeneği hakkında doğru ifade hangisidir?",
                                    options: ["Hemen hemen her karşılaşmada mevcuttur", "Sadece büyük liglerde mevcuttur", "Sadece tekli bahislerde mevcuttur", "Hiçbir karşılaşmada mevcut değildir"],
                                    correct: 0,
                                    explanation: "Cash Out seçeneği hemen hemen her karşılaşmada mevcuttur."
                                });
                            }
                        }
                        // Bahis bozdur özelliği bulunan bahisler, karşılaşmanın ertelenmesi durumunda bahis-bozdur özelliğini kaybeder.
                        if (item.includes("karşılaşmanın ertelenmesi durumunda bahis-bozdur özelliğini kaybeder")) {
                            if (!dynamicQuizzes.some(q => cleanText(q.question).includes(cleanText("Karşılaşmanın ertelenmesi Cash Out özelliğini nasıl etkiler?")))) {
                                dynamicQuizzes.push({
                                    question: "Karşılaşmanın ertelenmesi Cash Out özelliğini nasıl etkiler?",
                                    options: ["Özelliği kaybeder", "Daha yüksek oran sunar", "Otomatik olarak bozulur", "Değişmeden kalır"],
                                    correct: 0,
                                    explanation: "Bahis bozdur özelliği bulunan bahisler, karşılaşmanın ertelenmesi durumunda bahis-bozdur özelliğini kaybeder."
                                });
                            }
                        }
                        // Cash Out bahisler çevrime dahil değildir.
                        if (item.includes("Cash Out bahisler çevrime dahil değildir")) {
                             if (!dynamicQuizzes.some(q => cleanText(q.question).includes(cleanText("Cash Out bahisleri çevrim şartına dahil midir?")))) {
                                dynamicQuizzes.push({
                                    question: "Cash Out bahisleri çevrim şartına dahil midir?",
                                    options: ["Hayır, dahil değildir", "Evet, tamamen dahildir", "Kısmen dahildir", "Sadece belirli durumlarda dahildir"],
                                    correct: 0,
                                    explanation: "Cash Out bahisler çevrime dahil değildir."
                                });
                            }
                        }
                    }

                    // Kalamba özel soruları
                    if (promo.id === 'kalamba-cash-drop') {
                        // Minimum bahis tutarı
                        match = item.match(/en az\s*(\d+)\s*TL tutarında bahis almanız gerekmektedir/i);
                        if (match) {
                            const amount = cleanText(match[1] + " TL");
                            const question = `Kalamba Cash Drop turnuvasında ödülden faydalanabilmek için en az ne kadar bahis almanız gerekmektedir?`;
                            let options = [amount];
                            options = options.concat(generateNumericWrongOptions(amount, 3));
                            options = options.sort(() => Math.random() - 0.5);
                            const correctIndex = options.indexOf(amount);
                            if (correctIndex !== -1 && options.length > 1 && !dynamicQuizzes.some(q => cleanText(q.question) === cleanText(question))) {
                                dynamicQuizzes.push({
                                    question: question,
                                    options: options,
                                    correct: correctIndex,
                                    explanation: `Kalamba Cash Drop turnuvasında ödülden faydalanabilmek için en az ${amount} tutarında bahis almanız gerekmektedir.`
                                });
                            }
                        }
                        // Turnuva süresi
                        match = item.match(/promosyon\s*(\d+)\s*hafta boyunca sürecek/i);
                        if (match) {
                            const duration = cleanText(match[1] + " hafta");
                            const question = `Kalamba Cash Drop promosyonu kaç hafta boyunca sürecektir?`;
                            let options = [duration];
                            options = options.concat(generateTimeWrongOptions(duration, 3));
                            options = options.sort(() => Math.random() - 0.5);
                            const correctIndex = options.indexOf(duration);
                            if (correctIndex !== -1 && options.length > 1 && !dynamicQuizzes.some(q => cleanText(q.question) === cleanText(question))) {
                                dynamicQuizzes.push({
                                    question: question,
                                    options: options,
                                    correct: correctIndex,
                                    explanation: `Kalamba Cash Drop promosyonu ${duration} boyunca sürecektir.`
                                });
                            }
                        }
                        // Ödül dağıtımı
                        match = item.match(/ödüller\s*bahis değerlerine göre tamamen random olarak dağıtılmaktadır/i);
                        if (match) {
                            const answer = cleanText("Bahis değerlerine göre tamamen random olarak");
                            const question = `Kalamba Cash Drop turnuvasında ödüller nasıl dağıtılmaktadır?`;
                            let options = [answer];
                            options = options.concat(generateGeneralWrongOptions(answer, uniqueAllPossibleAnswers, 3));
                            options = options.sort(() => Math.random() - 0.5);
                            const correctIndex = options.indexOf(answer);
                            if (correctIndex !== -1 && options.length > 1 && !dynamicQuizzes.some(q => cleanText(q.question) === cleanText(question))) {
                                dynamicQuizzes.push({
                                    question: question,
                                    options: options,
                                    correct: correctIndex,
                                    explanation: `Kalamba Cash Drop turnuvasında ödüller ${answer} dağıtılmaktadır.`
                                });
                            }
                        }
                    }

                });
            }

            // Toplamda 30-40 soru olana kadar genel basicInfo ve title tabanlı sorular eklemeye devam et
            // Halihazırda eklenmiş olanları kontrol et
            const existingQuestions = new Set(dynamicQuizzes.map(q => cleanText(q.question)));

            if (promo.basicInfo) {
                for (const key in promo.basicInfo) {
                    if (Object.hasOwnProperty.call(promo.basicInfo, key)) {
                        const answer = cleanText(promo.basicInfo[key]);
                        if (answer && answer !== "Yok" && answer !== "Süresiz" && answer !== "Her zaman") {
                            const question = `${promo.title} promosyonunda "${key}" nedir?`;
                            if (!existingQuestions.has(cleanText(question))) {
                                let options = [answer];
                                if (key.includes("Miktar") || key.includes("Yatırım") || key.includes("Kazanç") || key.includes("Bahis") || key.includes("Freespin") || key.includes("Oran")) {
                                    options = options.concat(generateNumericWrongOptions(answer, 3));
                                } else if (key.includes("Tarih") || key.includes("Süresi") || key.includes("Günler")) {
                                    options = options.concat(generateTimeWrongOptions(answer, 3));
                                } else {
                                    options = options.concat(generateGeneralWrongOptions(answer, uniqueAllPossibleAnswers, 3));
                                }
                                options = options.sort(() => Math.random() - 0.5);
                                const correctIndex = options.indexOf(answer);
                                if (correctIndex !== -1 && options.length > 1) {
                                    dynamicQuizzes.push({
                                        question: question,
                                        options: options,
                                        correct: correctIndex,
                                        explanation: `${promo.title} promosyonunda "${key}", ${answer} olarak belirtilmiştir.`
                                    });
                                    existingQuestions.add(cleanText(question));
                                }
                            }
                        }
                    }
                }
            }

            // Promosyonun kendisiyle ilgili genel sorular ekle (eğer yeterli soru yoksa)
            if (dynamicQuizzes.length < 30) {
                // Kısa açıklama sorusu
                if (promo.shortDesc && promo.shortDesc !== "Yok" && !existingQuestions.has(cleanText(`${promo.title} promosyonunun kısa açıklaması nedir?`))) {
                    const question = `${promo.title} promosyonunun kısa açıklaması nedir?`;
                    const answer = cleanText(promo.shortDesc);
                    let options = [answer];
                    options = options.concat(generateGeneralWrongOptions(answer, uniqueAllPossibleAnswers, 3));
                    options = options.sort(() => Math.random() - 0.5);
                    const correctIndex = options.indexOf(answer);
                    if (correctIndex !== -1 && options.length > 1) {
                        dynamicQuizzes.push({
                            question: question,
                            options: options,
                            correct: correctIndex,
                            explanation: `${promo.title} promosyonunun kısa açıklaması: ${answer}`
                        });
                        existingQuestions.add(cleanText(question));
                    }
                }

                // Anahtar kelime sorusu
                if (promo.keywords) {
                    let keywordsArray = [];
                    if (Array.isArray(promo.keywords)) {
                        keywordsArray = promo.keywords.map(cleanText);
                    } else if (typeof promo.keywords === 'string') {
                        keywordsArray = promo.keywords.split(',').map(k => cleanText(k.trim())).filter(Boolean);
                    }

                    if (keywordsArray.length > 0 && !existingQuestions.has(cleanText(`${promo.title} promosyonunun anahtar kelimelerinden biri nedir?`))) {
                        const question = `${promo.title} promosyonunun anahtar kelimelerinden biri nedir?`;
                        const answer = keywordsArray[0];
                        let options = [answer];
                        options = options.concat(generateGeneralWrongOptions(answer, uniqueAllPossibleAnswers, 3));
                        options = options.sort(() => Math.random() - 0.5);
                        const correctIndex = options.indexOf(answer);
                        if (correctIndex !== -1 && options.length > 1) {
                            dynamicQuizzes.push({
                                question: question,
                                options: options,
                                correct: correctIndex,
                                explanation: `${promo.title} promosyonunun anahtar kelimelerinden biri: ${answer}`
                            });
                            existingQuestions.add(cleanText(question));
                        }
                    }
                }

                 // Genel Bonus Kuralları ile ilgili ek sorular
                if (!existingQuestions.has(cleanText("Hproject genel bonus kuralları bu promosyonda geçerli midir?"))) {
                    dynamicQuizzes.push({
                        question: "Hproject genel bonus kuralları bu promosyonda geçerli midir?",
                        options: ["Evet", "Hayır", "Kısmen", "Sadece belirli durumlarda"],
                        correct: 0,
                        explanation: "Evet, Hproject genel bonus kuralları bu promosyonda geçerlidir."
                    });
                    existingQuestions.add(cleanText("Hproject genel bonus kuralları bu promosyonda geçerli midir?"));
                }

                if (!existingQuestions.has(cleanText("Hproject, promosyonu dilediği zaman durdurma veya iptal etme hakkına sahip midir?"))) {
                    dynamicQuizzes.push({
                        question: "Hproject, promosyonu dilediği zaman durdurma veya iptal etme hakkına sahip midir?",
                        options: ["Evet", "Hayır", "Sadece üyelerin onayıyla", "Sadece belirli koşullarda"],
                        correct: 0,
                        explanation: "Evet, Hproject promosyonu dilediği zaman durdurma veya iptal etme hakkına sahiptir."
                    });
                    existingQuestions.add(cleanText("Hproject, promosyonu dilediği zaman durdurma veya iptal etme hakkına sahip midir?"));
                }

                if (!existingQuestions.has(cleanText("Bonusun kötüye kullanılması durumunda ne olur?"))) {
                    dynamicQuizzes.push({
                        question: "Bonusun kötüye kullanılması durumunda ne olur?",
                        options: ["Bonus ve kazanç geri alınır", "Sadece bonus iptal edilir", "Üyeliğe geçici el konulur", "Herhangi bir işlem yapılmaz"],
                        correct: 0,
                        explanation: "Bonus veya kazancını kötüye kullanma durumunda Hproject bonus ve kazancı geri alma hakkına sahiptir."
                    });
                    existingQuestions.add(cleanText("Bonusun kötüye kullanılması durumunda ne olur?"));
                }

                 // Yeni eklenen yatırım şartı ve yatırım yöntemi soruları
                 // Örnek: Minimum yatırım tutarı gerektiren promosyonlar için genel bir soru
                 const minInvestmentMatch = promo.basicInfo && (promo.basicInfo['Minimum Yatırım'] || promo.basicInfo['Minimum Bahis']);
                 if (minInvestmentMatch && !minInvestmentMatch.includes("Yok") && !existingQuestions.has(cleanText(`${promo.title} için minimum yatırım miktarı nedir?`))) {
                     const question = `${promo.title} için minimum yatırım miktarı nedir?`;
                     const answer = cleanText(minInvestmentMatch);
                     let options = [answer];
                     options = options.concat(generateNumericWrongOptions(answer, 3));
                     options = options.sort(() => Math.random() - 0.5);
                     const correctIndex = options.indexOf(answer);
                     if (correctIndex !== -1 && options.length > 1) {
                         dynamicQuizzes.push({
                             question: question,
                             options: options,
                             correct: correctIndex,
                             explanation: `${promo.title} için minimum yatırım miktarı ${answer} olarak belirtilmiştir.`
                         });
                         existingQuestions.add(cleanText(question));
                     }
                 }

                 // Ödeme yöntemleri ile ilgili soru
                 const paymentMethodMatch = allContentItems.find(item => item.match(/(?:yatırım yöntemi ile yatırım yapmanız gerekmektedir|mobil ödeme ve kredi kartı ile yatırım yapan üyelerimiz bu bonustan yararlanamamaktadır)/i));
                 if (paymentMethodMatch && !existingQuestions.has(cleanText(`${promo.title} promosyonu için geçerli olan/olmayan bir yatırım yöntemi belirtiniz.`))) {
                     let question = `Bu promosyondan yararlanmak için hangi yatırım yöntemlerinden biri kullanılabilir?`;
                     let answer = cleanText("Belirli yatırım yöntemleri"); // Genel bir cevap
                     
                     // Daha spesifik bir cevap bulmaya çalış
                     const positiveMethods = paymentMethodMatch.match(/(?:Trinkpara Havale|Trinkpara Papara|Trinkpara Paratim|Trinkpara Pep|Trinkpara Paybol|Trinkpara Popypara|Trinkpara Kripto|Anında Kripto)/ig);
                     const negativeMethods = paymentMethodMatch.match(/(?:mobil ödeme|kredi kartı)/ig);

                     if (positiveMethods && positiveMethods.length > 0) {
                         question = `${promo.title} promosyonundan yararlanmak için hangi yatırım yöntemlerinden biri kullanılabilir?`;
                         answer = cleanText(positiveMethods[0]);
                     } else if (negativeMethods && negativeMethods.length > 0) {
                         question = `${promo.title} promosyonundan yararlanamayan bir yatırım yöntemi hangisidir?`;
                         answer = cleanText(negativeMethods[0]);
                     }

                     let options = [answer];
                     options = options.concat(generateGeneralWrongOptions(answer, uniqueAllPossibleAnswers, 3));
                     options = options.sort(() => Math.random() - 0.5);
                     const correctIndex = options.indexOf(answer);
                     if (correctIndex !== -1 && options.length > 1) {
                         dynamicQuizzes.push({
                             question: question,
                             options: options,
                             correct: correctIndex,
                             explanation: `${promo.title} promosyonu için yatırım yöntemi bilgisi: ${answer}`
                         });
                         existingQuestions.add(cleanText(question));
                     }
                 }

                 // Anapara çevrimi ile ilgili genel soru
                 const anaparaCevrimiMatch = allContentItems.find(item => item.includes("Anapara Çevrimi"));
                 if (anaparaCevrimiMatch && !existingQuestions.has(cleanText("Anapara çevrimi nedir?"))) {
                      dynamicQuizzes.push({
                         question: "Anapara çevrimi nedir?",
                         options: [
                             "Yatırım tutarı kadar bahis yapmak",
                             "Bonus tutarı kadar bahis yapmak",
                             "Kayıp miktarı kadar bahis yapmak",
                             "Çekim yapmak için bir şart değildir"
                         ],
                         correct: 0,
                         explanation: "Anapara çevrimi, yatırım tutarı kadar bahis yapılması anlamına gelir."
                     });
                     existingQuestions.add(cleanText("Anapara çevrimi nedir?"));
                 }

                 // Çevrimsiz yatırım bonusu ile ilgili genel soru
                 const cevrimsizYatirimMatch = allContentItems.find(item => item.includes("Çevrimsiz Yatırım Bonusu"));
                 if (cevrimsizYatirimMatch && !existingQuestions.has(cleanText("Çevrimsiz yatırım bonusunun temel özelliği nedir?"))) {
                     dynamicQuizzes.push({
                         question: "Çevrimsiz yatırım bonusunun temel özelliği nedir?",
                         options: [
                             "Çevrim şartı gerektirmez",
                             "Sadece belirli oyunlarda geçerlidir",
                             "Çok yüksek çevrim şartı vardır",
                             "Sadece ilk yatırıma özeldir"
                         ],
                         correct: 0,
                         explanation: "Çevrimsiz yatırım bonusu, adından da anlaşılacağı gibi ekstra bir çevrim şartı gerektirmez."
                     });
                     existingQuestions.add(cleanText("Çevrimsiz yatırım bonusunun temel özelliği nedir?"));
                 }

                 // Kayıp bonusu ile ilgili genel soru
                 const kayipBonusuMatch = allContentItems.find(item => item.includes("Kayıp Bonusu"));
                 if (kayipBonusuMatch && !existingQuestions.has(cleanText("Kayıp bonusundan yararlanmak için genellikle hangi şart aranır?"))) {
                     dynamicQuizzes.push({
                         question: "Kayıp bonusundan yararlanmak için genellikle hangi şart aranır?",
                         options: [
                             "Bakiyenin tamamen sıfırlanması",
                             "Yüksek miktarda yatırım yapılması",
                             "Belirli bir oyun türünde kayıp yaşanması",
                             "Bonus talep edilmemesi"
                         ],
                         correct: 0,
                         explanation: "Kayıp bonusundan yararlanmak için genellikle bakiyenin belirli bir seviyenin altına düşmesi veya tamamen sıfırlanması şartı aranır."
                     });
                     existingQuestions.add(cleanText("Kayıp bonusundan yararlanmak için genellikle hangi şart aranır?"));
                 }

                  // Freebet kullanımı ile ilgili genel soru
                 const freebetMatch = allContentItems.find(item => item.includes("Freebet") && item.includes("kombine kuponlarda kullanılabilir"));
                 if (freebetMatch && !existingQuestions.has(cleanText("Freebet genellikle hangi tür kuponlarda kullanılabilir?"))) {
                     const matchKombine = freebetMatch.match(/(\d+\'lü|kombine)\s*kuponlarda/i);
                     let answer = "Kombine kuponlarda";
                     if (matchKombine) { answer = cleanText(matchKombine[0]); }

                     dynamicQuizzes.push({
                         question: "Freebet genellikle hangi tür kuponlarda kullanılabilir?",
                         options: [
                             answer,
                             "Tekli kuponlarda",
                             "Canlı bahislerde",
                             "Sadece casino oyunlarında"
                         ],
                         correct: 0,
                         explanation: `Freebet genellikle ${answer} kullanılabilir.`
                     });
                     existingQuestions.add(cleanText("Freebet genellikle hangi tür kuponlarda kullanılabilir?"));
                 }
            }


            return dynamicQuizzes;
        }

        let askedQuizIndices = {}; // Her promosyon için sorulan quiz indekslerini tutacak

        async function loadPromosData() {
            try {
                const promoFiles = [
                    'ertesi-gun.json',
                    'bonus-buy.json',
                    'hos-geldin.json',
                    'spor-freebet.json',
                    'casino-kayip-bonusu.json',
                    'freespin-600.json',
                    'cash-out.json'
                ];

                const providerPromoFiles = [
                    'pragmatic-play.json',
                    'kalamba-cash-drop.json'
                ];

                regularPromos = [];
                providerPromos = [];

                // Normal promosyonları yükle
                for (const file of promoFiles) {
                    try {
                        const promoResponse = await fetch(`../promosyonlar/${file}`);
                        if (promoResponse.ok) {
                            const promo = await promoResponse.json();
                            // Pragmatic Play'in yanlışlıkla burada olmadığından emin ol
                            if (promo.id !== 'pragmatic-play') {
                                regularPromos.push(promo);
                            }
                        }
                    } catch (error) {
                        console.error(`Error loading regular promo ${file}:`, error);
                    }
                }

                // Sağlayıcı promosyonlarını yükle
                for (const file of providerPromoFiles) {
                    try {
                        const promoResponse = await fetch(`../promosyonlar/${file}`);
                        if (promoResponse.ok) {
                            const promo = await promoResponse.json();
                            providerPromos.push(promo);
                        }
                    } catch (error) {
                        console.error(`Error loading provider promo ${file}:`, error);
                    }
                }

                // Başlangıçta aktif promosyonları ayarla ve select box'ı güncelle
                showQuizCategory(currentQuizCategory);
            } catch (error) {
                console.error('Error loading all promos data:', error);
            }
        }

        function updatePromoSelect() {
            const select = document.getElementById('promo-select');
            select.innerHTML = '<option value="">Promosyon seçin...</option>';
            
            activePromos.forEach(promo => {
                // Hem manuel hem de dinamik olarak oluşturulan quizlerin varlığını kontrol et
                const hasManualQuizzes = promo.quiz && (Array.isArray(promo.quiz) && promo.quiz.length > 0 || typeof promo.quiz === 'object' && Object.keys(promo.quiz).length > 0);
                const dynamicQuizzes = generateQuizQuestions(promo);
                const hasDynamicQuizzes = dynamicQuizzes.length > 0;

                if (hasManualQuizzes || hasDynamicQuizzes) {
                    const option = document.createElement('option');
                    option.value = promo.id;
                    option.textContent = promo.title;
                    select.appendChild(option);
                }
            });
        }

        function showQuizCategory(category) {
            currentQuizCategory = category;

            // Tab butonlarının stilini güncelle
            document.querySelectorAll('.quiz-category-tab').forEach(tab => {
                tab.style.background = '#1a3a6b';
                tab.style.color = '#ffffff';
                tab.classList.remove('active');
            });

            const activeTab = document.getElementById(`tab-${category}`);
            activeTab.style.background = '#ffc107';
            activeTab.style.color = '#0a1f44';
            activeTab.classList.add('active');

            // Aktif promosyon listesini ayarla
            if (category === 'promosyon') {
                activePromos = regularPromos;
            } else if (category === 'saglayici') {
                activePromos = providerPromos;
            }

            // Promosyon seçimini ve quiz içeriğini sıfırla
            document.getElementById('promo-select').value = '';
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('score-display').style.display = 'none';

            updatePromoSelect(); // Yeni listeye göre seçim kutusunu güncelle
        }

        function loadQuiz() {
            const selectedPromo = document.getElementById('promo-select').value;
            if (!selectedPromo) {
                document.getElementById('quiz-content').style.display = 'none';
                return;
            }

            const promo = activePromos.find(p => p.id === selectedPromo);
            if (!promo) {
                document.getElementById('quiz-content').style.display = 'none';
                alert('Bu promosyon için quiz bulunamadı!');
                return;
            }
            
            let allQuizzes = [];

            // Mevcut (manuel olarak eklenmiş) quizleri ekle
            if (promo.quiz) {
                allQuizzes = allQuizzes.concat(Array.isArray(promo.quiz) ? promo.quiz : [promo.quiz]);
            }
            
            // Dinamik olarak oluşturulan quizleri ekle
            const dynamicQuizzes = generateQuizQuestions(promo);
            allQuizzes = allQuizzes.concat(dynamicQuizzes);

            if (allQuizzes.length === 0) {
                document.getElementById('quiz-content').style.display = 'none';
                alert('Bu promosyon için quiz bulunamadı!');
                return;
            }

            // Bu promosyon için daha önce sorulan quiz indekslerini al
            if (!askedQuizIndices[selectedPromo]) {
                askedQuizIndices[selectedPromo] = [];
            }

            let availableQuizIndices = Array.from({ length: allQuizzes.length }, (_, i) => i);
            availableQuizIndices = availableQuizIndices.filter(index => !askedQuizIndices[selectedPromo].includes(index));

            if (availableQuizIndices.length === 0) {
                alert('Bu promosyon için tüm soruları yanıtladınız! Sorular tekrar edecektir.');
                askedQuizIndices[selectedPromo] = []; // Sorular bittiğinde listeyi sıfırla
                availableQuizIndices = Array.from({ length: allQuizzes.length }, (_, i) => i); // Tüm soruları tekrar kullanılabilir yap
            }

            const randomAvailableIndex = Math.floor(Math.random() * availableQuizIndices.length);
            const selectedQuizIndex = availableQuizIndices[randomAvailableIndex];

            currentQuiz = allQuizzes[selectedQuizIndex];
            askedQuizIndices[selectedPromo].push(selectedQuizIndex); // Sorulan soruyu işaretle
            
            document.getElementById('quiz-content').style.display = 'block';
            
            document.getElementById('quiz-question').textContent = currentQuiz.question;
            
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            
            currentQuiz.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'quiz-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectOption(optionDiv, index);
                optionsContainer.appendChild(optionDiv);
            });

            document.getElementById('score-display').style.display = 'none';
            document.getElementById('check-btn').disabled = false;
            currentAnswer = -1;
        }

        function selectOption(element, answerIndex) {
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.classList.remove('selected');
                option.classList.remove('correct');
                option.classList.remove('incorrect');
            });
            
            element.classList.add('selected');
            currentAnswer = answerIndex;
        }

        function checkAnswer() {
            if (currentAnswer === -1) {
                alert('Lütfen bir seçenek seçin!');
                return;
            }

            if (!currentQuiz) return;

            const options = document.querySelectorAll('.quiz-option');
            
            options[currentQuiz.correct].classList.add('correct');
            
            if (currentAnswer !== currentQuiz.correct) {
                options[currentAnswer].classList.add('incorrect');
            }

            document.getElementById('check-btn').disabled = true;
            
            const scoreDisplay = document.getElementById('score-display');
            const scoreText = document.getElementById('score-text');
            
            if (currentAnswer === currentQuiz.correct) {
                scoreText.innerHTML = `🎉 Tebrikler! Doğru cevap!<br><small>${currentQuiz.explanation}</small>`;
                scoreText.style.color = '#28a745';
            } else {
                scoreText.innerHTML = `❌ Yanlış cevap. Doğru cevap: ${currentQuiz.options[currentQuiz.correct]}<br><small>${currentQuiz.explanation}</small>`;
                scoreText.style.color = '#dc3545';
            }
            
            scoreDisplay.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadPromosData();
        });
    </script>
</body>
</html>
